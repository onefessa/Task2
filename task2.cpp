#include <iostream>
#include <stdio.h>
#include <math.h>
#include <fstream>
#include <cmath>
using namespace std;

double f_harm(double z){
	return z;
}

double g_harm(double x){
	return -x;
}

void RK_harm(){
	double k1,k2,k3,k4,k5,k6,k7,k8,k9,k10,k11,k12,k13,l1,l2,l3,l4,l5,l6,l7,l8,l9,l10,l11,l12,l13,x,z,x0,z0,x1,z1,t,T,h,tol,err1,err2,err,counter,sum,x_1,x_2,x_3,z_1,z_2,z_3, total_err;

	ofstream data ("data_harm.txt");

	for(int j=0; j<6;j++){
		if(j==0)
			T = M_PI;
		else
			T = M_PI*pow(10,j);

		for (int i=0;i<3;i++){
			tol = 1./pow(10.,8.+2.*i);
			x0=0.;
			z0=1.;
			t=0.;
			h=0.1;
			counter=1;
			sum=h;
			total_err=0;
			while(t<T){
				k1 = h*f_harm(z0);
				l1 = h*g_harm(x0);
				k2 = h*f_harm(z0 + (1/18.)*l1);
				l2 = h*g_harm(x0 + (1/18.)*k1);
				k3 = h*f_harm(z0+(1/48.)*l1 + (1/16.)*l2);
				l3 = h*g_harm(x0+(1/48.)*k1 + (1/16.)*k2);
				k4 = h*f_harm(z0 + (1/32.)*l1 + (3/32.)*l3);
				l4 = h*g_harm(x0 + (1/32.)*k1 + (3/32.)*k3);
				k5 = h*f_harm(z0 + (5/16.)*l1 - (75/64.)*l3 + (75/64.)*l4);
				l5 = h*g_harm(x0 + (5/16.)*k1 - (75/64.)*k3 + (75/64.)*k4);
				k6 = h*f_harm(z0 + (3/80.)*l1 + (3/16.)*l4 + (3/20.)*l5);
				l6 = h*g_harm(x0 + (3/80.)*k1 + (3/16.)*k4 + (3/20.)*k5);
				k7 = h*f_harm(z0 + (29443841/614563906.)*l1 + (77736538/692538347.)*l4 - (28693883/1125000000.)*l5 + (23124283/1800000000.)*l6);
				l7 = h*g_harm(x0 + (29443841/614563906.)*k1 + (77736538/692538347.)*k4 - (28693883/1125000000.)*k5 + (23124283/1800000000.)*k6);
				k8 = h*f_harm(z0 + (16016141/946692911.)*l1 + (61564180/158732637.)*l4 + (22789713/633445777.)*l5 + (545815736/2771057229.)*l6 - (180193667/1043307555.)*l7);
				l8 = h*g_harm(x0 + (16016141/946692911.)*k1 + (61564180/158732637.)*k4 + (22789713/633445777.)*k5 + (545815736/2771057229.)*k6 - (180193667/1043307555.)*k7);
				k9 = h*f_harm(z0 + (39632708/573591083.)*l1 - (433636366/683701615.)*l4 - (421739975/2616292301.)*l5 + (100302831/723423059.)*l6 + (790204164/839813087.)*l7 + (800635310/3783071287.)*l8);
				l9 = h*g_harm(x0 + (39632708/573591083.)*k1 - (433636366/683701615.)*k4 - (421739975/2616292301.)*k5 + (100302831/723423059.)*k6 + (790204164/839813087.)*k7 + (800635310/3783071287.)*k8);
				k10 = h*f_harm(z0 + (246121993/1340847787.)*l1 - (37695042795/15268766246.)*l4 - (309121744/1061227803.)*l5 - (12992083/490766935.)*l6 + (6005943493/2108947869.)*l7 + (393006217/1396673457.)*l8 + (123872331/1001029789.)*l9);
				l10 = h*g_harm(x0 + (246121993/1340847787.)*k1 - (37695042795/15268766246.)*k4 - (309121744/1061227803.)*k5 - (12992083/490766935.)*k6 + (6005943493/2108947869.)*k7 + (393006217/1396673457.)*k8 + (123872331/1001029789.)*k9);
				k11 = h*f_harm(z0 - (1028468189/846180014.)*l1 + (8478235783/508512852.)*l4 + (1311729495/1432422823.)*l5 - (10304129995/1701304382.)*l6 - (48777925059/3047939560.)*l7 + (15336726248/1032824649.)*l8 - (45442868181/3398467696.)*l9 + (3065993473/597172653.)*l10);
				l11 = h*g_harm(x0 - (1028468189/846180014.)*k1 + (8478235783/508512852.)*k4 + (1311729495/1432422823.)*k5 - (10304129995/1701304382.)*k6 - (48777925059/3047939560.)*k7 + (15336726248/1032824649.)*k8 - (45442868181/3398467696.)*k9 + (3065993473/597172653.)*k10);
				k12 = h*f_harm(z0 + (185892177/718116043.)*l1 - (3185094517/667107341.)*l4 - (477755414/1098053517.)*l5 - (703635378/230739211.)*l6 + (5731566787/1027545527.)*l7 + (5232866602/850066563.)*l8 - (4093664535/808688257.)*l9 + (3962137247/1805957418.)*l10 + (65686358/487910083.)*l11);
				l12 = h*g_harm(x0 + (185892177/718116043.)*k1 - (3185094517/667107341.)*k4 - (477755414/1098053517.)*k5 - (703635378/230739211.)*k6 + (5731566787/1027545527.)*k7 + (5232866602/850066563.)*k8 - (4093664535/808688257.)*k9 + (3962137247/1805957418.)*k10 + (65686358/487910083.)*k11);
				k13 = h*f_harm(z0 + (403863854/491063109.)*l1 - (5068492393/434740067.)*l4 - (411421997/543043805.)*l5 + (652783627/914296604.)*l6 + (11173962825/925320556.)*l7 - (13158990841/6184727034.)*l8 + (3936647629/1978049680.)*l9 - (160528059/685178525.)*l10 + (248638103/1413531060.)*l11);
				l13 = h*g_harm(x0 + (403863854/491063109.)*k1 - (5068492393/434740067.)*k4 - (411421997/543043805.)*k5 + (652783627/914296604.)*k6 + (11173962825/925320556.)*k7 - (13158990841/6184727034.)*k8 + (3936647629/1978049680.)*k9 - (160528059/685178525.)*k10 + (248638103/1413531060.)*k11);

				x = x0 + (13451932/455176623.)*k1 - (808719846/976000145.)*k6 + (1757004468/5645159321.)*k7 + (656045339/265891186.)*k8 - (3867574721/1518517206.)*k9 + (465885868/322736535.)*k10 + (53011238/667516719.)*k11 + (2/45.)*k12;
				z = z0 + (13451932/455176623.)*l1 - (808719846/976000145.)*l6 + (1757004468/5645159321.)*l7 + (656045339/265891186.)*l8 - (3867574721/1518517206.)*l9 + (465885868/322736535.)*l10 + (53011238/667516719.)*l11 + (2/45.)*l12;

				x1 = x0 + (14005451/335480064.)*k1 - (59238493/1068277852.)*k6 + (181606767/758867731.)*k7 + (561292985/797845732.)*k8 - (1041891430/1371343529.)*k9 + (760417239/1151165299.)*k10 + (118820643/751138087.)*k11 - (528747749/2220607170.)*k12 + (1/4.)*k13;
				z1 = z0 + (14005451/335480064.)*l1 - (59238493/1068277852.)*l6 + (181606767/758867731.)*l7 + (561292985/797845732.)*l8 - (1041891430/1371343529.)*l9 + (760417239/1151165299.)*l10 + (118820643/751138087.)*l11 - (528747749/2220607170.)*l12 + (1/4.)*l13;

				err1=fabs(x-x1);
				err2=fabs(z-z1);
				err=fmax(err1,err2)/127.;

				if(err>tol){
					h=h*fmin(2, fmax(0.7, 0.98*pow(tol/err, 1/8.)));
				}
				else{
					t = t + h;
					if(t<=T){
						sum = sum + h;
						total_err = total_err + err;
						counter++;
						h=h*fmin(2, fmax(0.7, 0.98*pow(tol/err, 1/8.)));
						x0=x;
						z0=z;
					}
					else{
						t = t - h;
						h = T - t;
					}
				}
				printf("Time: %e. h: %e x: %e z: %e err:%e tol:%e \n", t/T, h, x0, z0, err, tol);
			}
			if(i==0){
				x_1=x0;
				z_1=z0;
			}
			if(i==1){
				x_2=x0;
				z_2=z0;
			}
			if(i==2){
				x_3=x0;
				z_3=z0;
			}
			data<<"$" <<T/M_PI<<"\\pi$ & $"<<tol<<"$ & $"<<fabs(x0)<<"$ & $"<<fabs(z0 - cos(T))<<"$ & $"<<counter<<"$ & $"<<sum/counter<<"$ $"<<total_err<<"$ \\\\"<<endl;
		}
		data<<"$"<<fabs((x_1 - x_2)/(x_2-x_3))<<"$ & $"<<fabs((z_1 - z_2)/(z_2-z_3))<<"$ \\\\"<<endl;
	}
}

double f_x(double y){
	return y;
}

double f_y(double p_y){
	return p_y;
}

double fp_x(double x, double y, double a){
	return -24*a*y*sin(a*x)/pow(2 + cos(a*x), 2);
}

double fp_y(double x, double y, double p_x, double a){
	return -p_x + 24./(2 + cos(a*x));
}

double B0(double x, double y, double p_y, double a){
	return pow(p_y,2) - 48.*y/(2+cos(a*x));
}

double RK(double x0, double p_y0, double a, int target){
	double k1,k2,k3,k4,k5,k6,k7,k8,k9,k10,k11,k12,k13;
	double l1,l2,l3,l4,l5,l6,l7,l8,l9,l10,l11,l12,l13;
	double m1,m2,m3,m4,m5,m6,m7,m8,m9,m10,m11,m12,m13;
	double n1,n2,n3,n4,n5,n6,n7,n8,n9,n10,n11,n12,n13;
	double o1,o2,o3,o4,o5,o6,o7,o8,o9,o10,o11,o12,o13;

	ofstream data ("alpha0.txt");

	double y0, p_x0, x, y, p_x, p_y, T, tol, err, err1, err2, err3, err4, err5, h, x1, y1, p_x1, p_y1, t, B, B_0, B_1, total_err;
	tol = 1./pow(10.,12);
	h=0.01;
	t=0.;
	T=1.;
	y0=0;
	p_x0=0;
	B_0=0.;
	total_err=0.;
	while(t<T){
		k1 = h*f_x(y0);
		l1 = h*f_y(p_y0);
		m1 = h*fp_x(x0, y0, a);
		n1 = h*fp_y(x0, y0, p_x0, a);
		o1 = h*B0(x0, y0, p_y0, a);

		k2 = h*f_x(y0 + (1/18.)*l1);
		l2 = h*f_y(p_y0 + (1/18.)*n1);
		m2 = h*fp_x(x0 + (1/18.)*k1, y0 + (1/18.)*l1, a);
		n2 = h*fp_y(x0 + (1/18.)*k1, y0 + (1/18.)*l1, p_x0 + (1/18.)*m1, a);
		o2 = h*B0(x0 + (1/18.)*k1, y0 + (1/18.)*l1, p_y0 + (1/18.)*n1, a);

		k3 = h*f_x(y0+(1/48.)*l1 + (1/16.)*l2);
		l3 = h*f_y(p_y0+(1/48.)*n1 + (1/16.)*n2);
		m3 = h*fp_x(x0+(1/48.)*k1 + (1/16.)*k2, y0+(1/48.)*l1 + (1/16.)*l2, a);
		n3 = h*fp_y(x0+(1/48.)*k1 + (1/16.)*k2, y0+(1/48.)*l1 + (1/16.)*l2, p_x0+(1/48.)*m1 + (1/16.)*m2, a);
		o3 = h*B0(x0+(1/48.)*k1 + (1/16.)*k2, y0+(1/48.)*l1 + (1/16.)*l2, p_y0+(1/48.)*n1 + (1/16.)*n2, a);

		k4 = h*f_x(y0 + (1/32.)*l1 + (3/32.)*l3);
		l4 = h*f_y(p_y0 + (1/32.)*n1 + (3/32.)*n3);
		m4 = h*fp_x(x0 + (1/32.)*k1 + (3/32.)*k3, y0 + (1/32.)*l1 + (3/32.)*l3, a);
		n4 = h*fp_y(x0 + (1/32.)*k1 + (3/32.)*k3, y0 + (1/32.)*l1 + (3/32.)*l3, p_x0 + (1/32.)*m1 + (3/32.)*m3, a);
		o4 = h*B0(x0 + (1/32.)*k1 + (3/32.)*k3, y0 + (1/32.)*l1 + (3/32.)*l3, p_y0 + (1/32.)*n1 + (3/32.)*n3,  a);

		k5 = h*f_x(y0 + (5/16.)*l1 - (75/64.)*l3 + (75/64.)*l4);
		l5 = h*f_y(p_y0 + (5/16.)*n1 - (75/64.)*n3 + (75/64.)*n4);
		m5 = h*fp_x(x0 + (5/16.)*k1 - (75/64.)*k3 + (75/64.)*k4, y0 + (5/16.)*l1 - (75/64.)*l3 + (75/64.)*l4, a);
		n5 = h*fp_y(x0 + (5/16.)*k1 - (75/64.)*k3 + (75/64.)*k4, y0 + (5/16.)*l1 - (75/64.)*l3 + (75/64.)*l4, p_x0 + (5/16.)*m1 - (75/64.)*m3 + (75/64.)*m4, a);
		o5 = h*B0(x0 + (5/16.)*k1 - (75/64.)*k3 + (75/64.)*k4, y0 + (5/16.)*l1 - (75/64.)*l3 + (75/64.)*l4, p_y0 + (5/16.)*n1 - (75/64.)*n3 + (75/64.)*n4,  a);

		k6 = h*f_x(y0 + (3/80.)*l1 + (3/16.)*l4 + (3/20.)*l5);
		l6 = h*f_y(p_y0 + (3/80.)*n1 + (3/16.)*n4 + (3/20.)*n5);
		m6 = h*fp_x(x0 + (3/80.)*k1 + (3/16.)*k4 + (3/20.)*k5, y0 + (3/80.)*l1 + (3/16.)*l4 + (3/20.)*l5, a);
		n6 = h*fp_y(x0 + (3/80.)*k1 + (3/16.)*k4 + (3/20.)*k5, y0 + (3/80.)*l1 + (3/16.)*l4 + (3/20.)*l5, p_x0 + (3/80.)*m1 + (3/16.)*m4 + (3/20.)*m5, a);
		o6 = h*B0(x0 + (3/80.)*k1 + (3/16.)*k4 + (3/20.)*k5, y0 + (3/80.)*l1 + (3/16.)*l4 + (3/20.)*l5, p_y0 + (3/80.)*n1 + (3/16.)*n4 + (3/20.)*n5, a);

		k7 = h*f_x(y0 + (29443841/614563906.)*l1 + (77736538/692538347.)*l4 - (28693883/1125000000.)*l5 + (23124283/1800000000.)*l6);
		l7 = h*f_y(p_y0 + (29443841/614563906.)*n1 + (77736538/692538347.)*n4 - (28693883/1125000000.)*n5 + (23124283/1800000000.)*n6);
		m7 = h*fp_x(x0 + (29443841/614563906.)*k1 + (77736538/692538347.)*k4 - (28693883/1125000000.)*k5 + (23124283/1800000000.)*k6, y0 + (29443841/614563906.)*l1 + (77736538/692538347.)*l4 - (28693883/1125000000.)*l5 + (23124283/1800000000.)*l6, a);
		n7 = h*fp_y(x0 + (29443841/614563906.)*k1 + (77736538/692538347.)*k4 - (28693883/1125000000.)*k5 + (23124283/1800000000.)*k6, y0 + (29443841/614563906.)*l1 + (77736538/692538347.)*l4 - (28693883/1125000000.)*l5 + (23124283/1800000000.)*l6, p_x0 + (29443841/614563906.)*m1 + (77736538/692538347.)*m4 - (28693883/1125000000.)*m5 + (23124283/1800000000.)*m6,a);
		o7 = h*B0(x0 + (29443841/614563906.)*k1 + (77736538/692538347.)*k4 - (28693883/1125000000.)*k5 + (23124283/1800000000.)*k6, y0 + (29443841/614563906.)*l1 + (77736538/692538347.)*l4 - (28693883/1125000000.)*l5 + (23124283/1800000000.)*l6, p_y0 + (29443841/614563906.)*n1 + (77736538/692538347.)*n4 - (28693883/1125000000.)*n5 + (23124283/1800000000.)*n6, a);

		k8 = h*f_x(y0 + (16016141/946692911.)*l1 + (61564180/158732637.)*l4 + (22789713/633445777.)*l5 + (545815736/2771057229.)*l6 - (180193667/1043307555.)*l7);
		l8 = h*f_y(p_y0 + (16016141/946692911.)*n1 + (61564180/158732637.)*n4 + (22789713/633445777.)*n5 + (545815736/2771057229.)*n6 - (180193667/1043307555.)*n7);
		m8 = h*fp_x(x0 + (16016141/946692911.)*k1 + (61564180/158732637.)*k4 + (22789713/633445777.)*k5 + (545815736/2771057229.)*k6 - (180193667/1043307555.)*k7, y0 + (16016141/946692911.)*l1 + (61564180/158732637.)*l4 + (22789713/633445777.)*l5 + (545815736/2771057229.)*l6 - (180193667/1043307555.)*l7, a);
		n8 = h*fp_y(x0 + (16016141/946692911.)*k1 + (61564180/158732637.)*k4 + (22789713/633445777.)*k5 + (545815736/2771057229.)*k6 - (180193667/1043307555.)*k7, y0 + (16016141/946692911.)*l1 + (61564180/158732637.)*l4 + (22789713/633445777.)*l5 + (545815736/2771057229.)*l6 - (180193667/1043307555.)*l7, p_x0 + (16016141/946692911.)*m1 + (61564180/158732637.)*m4 + (22789713/633445777.)*m5 + (545815736/2771057229.)*m6 - (180193667/1043307555.)*m7, a);
		o8 = h*B0(x0 + (16016141/946692911.)*k1 + (61564180/158732637.)*k4 + (22789713/633445777.)*k5 + (545815736/2771057229.)*k6 - (180193667/1043307555.)*k7, y0 + (16016141/946692911.)*l1 + (61564180/158732637.)*l4 + (22789713/633445777.)*l5 + (545815736/2771057229.)*l6 - (180193667/1043307555.)*l7, p_y0 + (16016141/946692911.)*n1 + (61564180/158732637.)*n4 + (22789713/633445777.)*n5 + (545815736/2771057229.)*n6 - (180193667/1043307555.)*n7, a);

		k9 = h*f_x(y0 + (39632708/573591083.)*l1 - (433636366/683701615.)*l4 - (421739975/2616292301.)*l5 + (100302831/723423059.)*l6 + (790204164/839813087.)*l7 + (800635310/3783071287.)*l8);
		l9 = h*f_y(p_y0 + (39632708/573591083.)*n1 - (433636366/683701615.)*n4 - (421739975/2616292301.)*n5 + (100302831/723423059.)*n6 + (790204164/839813087.)*n7 + (800635310/3783071287.)*n8);
		m9 = h*fp_x(x0 + (39632708/573591083.)*k1 - (433636366/683701615.)*k4 - (421739975/2616292301.)*k5 + (100302831/723423059.)*k6 + (790204164/839813087.)*k7 + (800635310/3783071287.)*k8, y0 + (39632708/573591083.)*l1 - (433636366/683701615.)*l4 - (421739975/2616292301.)*l5 + (100302831/723423059.)*l6 + (790204164/839813087.)*l7 + (800635310/3783071287.)*l8, a);
		n9 = h*fp_y(x0 + (39632708/573591083.)*k1 - (433636366/683701615.)*k4 - (421739975/2616292301.)*k5 + (100302831/723423059.)*k6 + (790204164/839813087.)*k7 + (800635310/3783071287.)*k8, y0 + (39632708/573591083.)*l1 - (433636366/683701615.)*l4 - (421739975/2616292301.)*l5 + (100302831/723423059.)*l6 + (790204164/839813087.)*l7 + (800635310/3783071287.)*l8, p_x0 + (39632708/573591083.)*m1 - (433636366/683701615.)*m4 - (421739975/2616292301.)*m5 + (100302831/723423059.)*m6 + (790204164/839813087.)*m7 + (800635310/3783071287.)*m8, a);
		o9 = h*B0(x0 + (39632708/573591083.)*k1 - (433636366/683701615.)*k4 - (421739975/2616292301.)*k5 + (100302831/723423059.)*k6 + (790204164/839813087.)*k7 + (800635310/3783071287.)*k8, y0 + (39632708/573591083.)*l1 - (433636366/683701615.)*l4 - (421739975/2616292301.)*l5 + (100302831/723423059.)*l6 + (790204164/839813087.)*l7 + (800635310/3783071287.)*l8, p_y0 + (39632708/573591083.)*n1 - (433636366/683701615.)*n4 - (421739975/2616292301.)*n5 + (100302831/723423059.)*n6 + (790204164/839813087.)*n7 + (800635310/3783071287.)*n8, a);

		k10 = h*f_x(y0 + (246121993/1340847787.)*l1 - (37695042795/15268766246.)*l4 - (309121744/1061227803.)*l5 - (12992083/490766935.)*l6 + (6005943493/2108947869.)*l7 + (393006217/1396673457.)*l8 + (123872331/1001029789.)*l9);
		l10 = h*f_y(p_y0 + (246121993/1340847787.)*n1 - (37695042795/15268766246.)*n4 - (309121744/1061227803.)*n5 - (12992083/490766935.)*n6 + (6005943493/2108947869.)*n7 + (393006217/1396673457.)*n8 + (123872331/1001029789.)*n9);
		m10 = h*fp_x(x0 + (246121993/1340847787.)*k1 - (37695042795/15268766246.)*k4 - (309121744/1061227803.)*k5 - (12992083/490766935.)*k6 + (6005943493/2108947869.)*k7 + (393006217/1396673457.)*k8 + (123872331/1001029789.)*k9, y0 + (246121993/1340847787.)*l1 - (37695042795/15268766246.)*l4 - (309121744/1061227803.)*l5 - (12992083/490766935.)*l6 + (6005943493/2108947869.)*l7 + (393006217/1396673457.)*l8 + (123872331/1001029789.)*l9, a);
		n10 = h*fp_y(x0 + (246121993/1340847787.)*k1 - (37695042795/15268766246.)*k4 - (309121744/1061227803.)*k5 - (12992083/490766935.)*k6 + (6005943493/2108947869.)*k7 + (393006217/1396673457.)*k8 + (123872331/1001029789.)*k9, y0 + (246121993/1340847787.)*l1 - (37695042795/15268766246.)*l4 - (309121744/1061227803.)*l5 - (12992083/490766935.)*l6 + (6005943493/2108947869.)*l7 + (393006217/1396673457.)*l8 + (123872331/1001029789.)*l9, p_x0 + (246121993/1340847787.)*m1 - (37695042795/15268766246.)*m4 - (309121744/1061227803.)*m5 - (12992083/490766935.)*m6 + (6005943493/2108947869.)*m7 + (393006217/1396673457.)*m8 + (123872331/1001029789.)*m9, a);
		o10 = h*B0(x0 + (246121993/1340847787.)*k1 - (37695042795/15268766246.)*k4 - (309121744/1061227803.)*k5 - (12992083/490766935.)*k6 + (6005943493/2108947869.)*k7 + (393006217/1396673457.)*k8 + (123872331/1001029789.)*k9, y0 + (246121993/1340847787.)*l1 - (37695042795/15268766246.)*l4 - (309121744/1061227803.)*l5 - (12992083/490766935.)*l6 + (6005943493/2108947869.)*l7 + (393006217/1396673457.)*l8 + (123872331/1001029789.)*l9, p_y0 + (246121993/1340847787.)*n1 - (37695042795/15268766246.)*n4 - (309121744/1061227803.)*n5 - (12992083/490766935.)*n6 + (6005943493/2108947869.)*n7 + (393006217/1396673457.)*n8 + (123872331/1001029789.)*n9, a);

		k11 = h*f_x(y0 - (1028468189/846180014.)*l1 + (8478235783/508512852.)*l4 + (1311729495/1432422823.)*l5 - (10304129995/1701304382.)*l6 - (48777925059/3047939560.)*l7 + (15336726248/1032824649.)*l8 - (45442868181/3398467696.)*l9 + (3065993473/597172653.)*l10);
		l11 = h*f_y(p_y0 - (1028468189/846180014.)*n1 + (8478235783/508512852.)*n4 + (1311729495/1432422823.)*n5 - (10304129995/1701304382.)*n6 - (48777925059/3047939560.)*n7 + (15336726248/1032824649.)*n8 - (45442868181/3398467696.)*n9 + (3065993473/597172653.)*n10);
		m11 = h*fp_x(x0 - (1028468189/846180014.)*k1 + (8478235783/508512852.)*k4 + (1311729495/1432422823.)*k5 - (10304129995/1701304382.)*k6 - (48777925059/3047939560.)*k7 + (15336726248/1032824649.)*k8 - (45442868181/3398467696.)*k9 + (3065993473/597172653.)*k10, y0 - (1028468189/846180014.)*l1 + (8478235783/508512852.)*l4 + (1311729495/1432422823.)*l5 - (10304129995/1701304382.)*l6 - (48777925059/3047939560.)*l7 + (15336726248/1032824649.)*l8 - (45442868181/3398467696.)*l9 + (3065993473/597172653.)*l10, a);
		n11 = h*fp_y(x0 - (1028468189/846180014.)*k1 + (8478235783/508512852.)*k4 + (1311729495/1432422823.)*k5 - (10304129995/1701304382.)*k6 - (48777925059/3047939560.)*k7 + (15336726248/1032824649.)*k8 - (45442868181/3398467696.)*k9 + (3065993473/597172653.)*k10, y0 - (1028468189/846180014.)*l1 + (8478235783/508512852.)*l4 + (1311729495/1432422823.)*l5 - (10304129995/1701304382.)*l6 - (48777925059/3047939560.)*l7 + (15336726248/1032824649.)*l8 - (45442868181/3398467696.)*l9 + (3065993473/597172653.)*l10, p_x0 - (1028468189/846180014.)*m1 + (8478235783/508512852.)*m4 + (1311729495/1432422823.)*m5 - (10304129995/1701304382.)*m6 - (48777925059/3047939560.)*m7 + (15336726248/1032824649.)*m8 - (45442868181/3398467696.)*m9 + (3065993473/597172653.)*m10, a);
		o11 = h*B0(x0 - (1028468189/846180014.)*k1 + (8478235783/508512852.)*k4 + (1311729495/1432422823.)*k5 - (10304129995/1701304382.)*k6 - (48777925059/3047939560.)*k7 + (15336726248/1032824649.)*k8 - (45442868181/3398467696.)*k9 + (3065993473/597172653.)*k10, y0 - (1028468189/846180014.)*l1 + (8478235783/508512852.)*l4 + (1311729495/1432422823.)*l5 - (10304129995/1701304382.)*l6 - (48777925059/3047939560.)*l7 + (15336726248/1032824649.)*l8 - (45442868181/3398467696.)*l9 + (3065993473/597172653.)*l10, p_y0 - (1028468189/846180014.)*n1 + (8478235783/508512852.)*n4 + (1311729495/1432422823.)*n5 - (10304129995/1701304382.)*n6 - (48777925059/3047939560.)*n7 + (15336726248/1032824649.)*n8 - (45442868181/3398467696.)*n9 + (3065993473/597172653.)*n10, a);

		k12 = h*f_x(y0 + (185892177/718116043.)*l1 - (3185094517/667107341.)*l4 - (477755414/1098053517.)*l5 - (703635378/230739211.)*l6 + (5731566787/1027545527.)*l7 + (5232866602/850066563.)*l8 - (4093664535/808688257.)*l9 + (3962137247/1805957418.)*l10 + (65686358/487910083.)*l11);
		l12 = h*f_y(p_y0 + (185892177/718116043.)*n1 - (3185094517/667107341.)*n4 - (477755414/1098053517.)*n5 - (703635378/230739211.)*n6 + (5731566787/1027545527.)*n7 + (5232866602/850066563.)*n8 - (4093664535/808688257.)*n9 + (3962137247/1805957418.)*n10 + (65686358/487910083.)*n11);
		m12 = h*fp_x(x0 + (185892177/718116043.)*k1 - (3185094517/667107341.)*k4 - (477755414/1098053517.)*k5 - (703635378/230739211.)*k6 + (5731566787/1027545527.)*k7 + (5232866602/850066563.)*k8 - (4093664535/808688257.)*k9 + (3962137247/1805957418.)*k10 + (65686358/487910083.)*k11, y0 + (185892177/718116043.)*l1 - (3185094517/667107341.)*l4 - (477755414/1098053517.)*l5 - (703635378/230739211.)*l6 + (5731566787/1027545527.)*l7 + (5232866602/850066563.)*l8 - (4093664535/808688257.)*l9 + (3962137247/1805957418.)*l10 + (65686358/487910083.)*l11, a);
		n12 = h*fp_y(x0 + (185892177/718116043.)*k1 - (3185094517/667107341.)*k4 - (477755414/1098053517.)*k5 - (703635378/230739211.)*k6 + (5731566787/1027545527.)*k7 + (5232866602/850066563.)*k8 - (4093664535/808688257.)*k9 + (3962137247/1805957418.)*k10 + (65686358/487910083.)*k11, y0 + (185892177/718116043.)*l1 - (3185094517/667107341.)*l4 - (477755414/1098053517.)*l5 - (703635378/230739211.)*l6 + (5731566787/1027545527.)*l7 + (5232866602/850066563.)*l8 - (4093664535/808688257.)*l9 + (3962137247/1805957418.)*l10 + (65686358/487910083.)*l11, p_x0 + (185892177/718116043.)*m1 - (3185094517/667107341.)*m4 - (477755414/1098053517.)*m5 - (703635378/230739211.)*m6 + (5731566787/1027545527.)*m7 + (5232866602/850066563.)*m8 - (4093664535/808688257.)*m9 + (3962137247/1805957418.)*m10 + (65686358/487910083.)*m11, a);
		o12 = h*B0(x0 + (185892177/718116043.)*k1 - (3185094517/667107341.)*k4 - (477755414/1098053517.)*k5 - (703635378/230739211.)*k6 + (5731566787/1027545527.)*k7 + (5232866602/850066563.)*k8 - (4093664535/808688257.)*k9 + (3962137247/1805957418.)*k10 + (65686358/487910083.)*k11, y0 + (185892177/718116043.)*l1 - (3185094517/667107341.)*l4 - (477755414/1098053517.)*l5 - (703635378/230739211.)*l6 + (5731566787/1027545527.)*l7 + (5232866602/850066563.)*l8 - (4093664535/808688257.)*l9 + (3962137247/1805957418.)*l10 + (65686358/487910083.)*l11, p_y0 + (185892177/718116043.)*n1 - (3185094517/667107341.)*n4 - (477755414/1098053517.)*n5 - (703635378/230739211.)*n6 + (5731566787/1027545527.)*n7 + (5232866602/850066563.)*n8 - (4093664535/808688257.)*n9 + (3962137247/1805957418.)*n10 + (65686358/487910083.)*n11, a);

		k13 = h*f_x(y0 + (403863854/491063109.)*l1 - (5068492393/434740067.)*l4 - (411421997/543043805.)*l5 + (652783627/914296604.)*l6 + (11173962825/925320556.)*l7 - (13158990841/6184727034.)*l8 + (3936647629/1978049680.)*l9 - (160528059/685178525.)*l10 + (248638103/1413531060.)*l11);
		l13 = h*f_y(p_y0 + (403863854/491063109.)*n1 - (5068492393/434740067.)*n4 - (411421997/543043805.)*n5 + (652783627/914296604.)*n6 + (11173962825/925320556.)*n7 - (13158990841/6184727034.)*n8 + (3936647629/1978049680.)*n9 - (160528059/685178525.)*n10 + (248638103/1413531060.)*n11);
		m13 = h*fp_x(x0 + (403863854/491063109.)*k1 - (5068492393/434740067.)*k4 - (411421997/543043805.)*k5 + (652783627/914296604.)*k6 + (11173962825/925320556.)*k7 - (13158990841/6184727034.)*k8 + (3936647629/1978049680.)*k9 - (160528059/685178525.)*k10 + (248638103/1413531060.)*k11, y0 + (403863854/491063109.)*l1 - (5068492393/434740067.)*l4 - (411421997/543043805.)*l5 + (652783627/914296604.)*l6 + (11173962825/925320556.)*l7 - (13158990841/6184727034.)*l8 + (3936647629/1978049680.)*l9 - (160528059/685178525.)*l10 + (248638103/1413531060.)*l11, a);
		n13 = h*fp_y(x0 + (403863854/491063109.)*k1 - (5068492393/434740067.)*k4 - (411421997/543043805.)*k5 + (652783627/914296604.)*k6 + (11173962825/925320556.)*k7 - (13158990841/6184727034.)*k8 + (3936647629/1978049680.)*k9 - (160528059/685178525.)*k10 + (248638103/1413531060.)*k11, y0 + (403863854/491063109.)*l1 - (5068492393/434740067.)*l4 - (411421997/543043805.)*l5 + (652783627/914296604.)*l6 + (11173962825/925320556.)*l7 - (13158990841/6184727034.)*l8 + (3936647629/1978049680.)*l9 - (160528059/685178525.)*l10 + (248638103/1413531060.)*l11, p_x0 + (403863854/491063109.)*m1 - (5068492393/434740067.)*m4 - (411421997/543043805.)*m5 + (652783627/914296604.)*m6 + (11173962825/925320556.)*m7 - (13158990841/6184727034.)*m8 + (3936647629/1978049680.)*m9 - (160528059/685178525.)*m10 + (248638103/1413531060.)*m11, a);
		o13 = h*B0(x0 + (403863854/491063109.)*k1 - (5068492393/434740067.)*k4 - (411421997/543043805.)*k5 + (652783627/914296604.)*k6 + (11173962825/925320556.)*k7 - (13158990841/6184727034.)*k8 + (3936647629/1978049680.)*k9 - (160528059/685178525.)*k10 + (248638103/1413531060.)*k11, y0 + (403863854/491063109.)*l1 - (5068492393/434740067.)*l4 - (411421997/543043805.)*l5 + (652783627/914296604.)*l6 + (11173962825/925320556.)*l7 - (13158990841/6184727034.)*l8 + (3936647629/1978049680.)*l9 - (160528059/685178525.)*l10 + (248638103/1413531060.)*l11, p_y0 + (403863854/491063109.)*n1 - (5068492393/434740067.)*n4 - (411421997/543043805.)*n5 + (652783627/914296604.)*n6 + (11173962825/925320556.)*n7 - (13158990841/6184727034.)*n8 + (3936647629/1978049680.)*n9 - (160528059/685178525.)*n10 + (248638103/1413531060.)*n11, a);

		x = x0 + (13451932/455176623.)*k1 - (808719846/976000145.)*k6 + (1757004468/5645159321.)*k7 + (656045339/265891186.)*k8 - (3867574721/1518517206.)*k9 + (465885868/322736535.)*k10 + (53011238/667516719.)*k11 + (2/45.)*k12;
		y = y0 + (13451932/455176623.)*l1 - (808719846/976000145.)*l6 + (1757004468/5645159321.)*l7 + (656045339/265891186.)*l8 - (3867574721/1518517206.)*l9 + (465885868/322736535.)*l10 + (53011238/667516719.)*l11 + (2/45.)*l12;
		p_x = p_x0 + (13451932/455176623.)*m1 - (808719846/976000145.)*m6 + (1757004468/5645159321.)*m7 + (656045339/265891186.)*m8 - (3867574721/1518517206.)*m9 + (465885868/322736535.)*m10 + (53011238/667516719.)*m11 + (2/45.)*m12;
		p_y = p_y0 + (13451932/455176623.)*n1 - (808719846/976000145.)*n6 + (1757004468/5645159321.)*n7 + (656045339/265891186.)*n8 - (3867574721/1518517206.)*n9 + (465885868/322736535.)*n10 + (53011238/667516719.)*n11 + (2/45.)*n12;
		B = B_0 + (13451932/455176623.)*o1 - (808719846/976000145.)*o6 + (1757004468/5645159321.)*o7 + (656045339/265891186.)*o8 - (3867574721/1518517206.)*o9 + (465885868/322736535.)*o10 + (53011238/667516719.)*o11 + (2/45.)*o12;

		x1 = x0 + (14005451/335480064.)*k1 - (59238493/1068277852.)*k6 + (181606767/758867731.)*k7 + (561292985/797845732.)*k8 - (1041891430/1371343529.)*k9 + (760417239/1151165299.)*k10 + (118820643/751138087.)*k11 - (528747749/2220607170.)*k12 + (1/4.)*k13;
		y1 = y0 + (14005451/335480064.)*l1 - (59238493/1068277852.)*l6 + (181606767/758867731.)*l7 + (561292985/797845732.)*l8 - (1041891430/1371343529.)*l9 + (760417239/1151165299.)*l10 + (118820643/751138087.)*l11 - (528747749/2220607170.)*l12 + (1/4.)*l13;
		p_x1 = p_x0 + (14005451/335480064.)*m1 - (59238493/1068277852.)*m6 + (181606767/758867731.)*m7 + (561292985/797845732.)*m8 - (1041891430/1371343529.)*m9 + (760417239/1151165299.)*m10 + (118820643/751138087.)*m11 - (528747749/2220607170.)*m12 + (1/4.)*m13;
		p_y1 = p_y0 + (14005451/335480064.)*n1 - (59238493/1068277852.)*n6 + (181606767/758867731.)*n7 + (561292985/797845732.)*n8 - (1041891430/1371343529.)*n9 + (760417239/1151165299.)*n10 + (118820643/751138087.)*n11 - (528747749/2220607170.)*n12 + (1/4.)*n13;;
		B_1 = B_0 + (14005451/335480064.)*o1 - (59238493/1068277852.)*o6 + (181606767/758867731.)*o7 + (561292985/797845732.)*o8 - (1041891430/1371343529.)*o9 + (760417239/1151165299.)*o10 + (118820643/751138087.)*o11 - (528747749/2220607170.)*o12 + (1/4.)*o13;;

		if(target != 3){
			err1=fabs(x-x1);
			err2=fabs(y-y1);
			err3=fabs(p_x - p_x1);
			err4=fabs(p_y - p_y1);
			err5=fabs(B-B_1);
			//err=fmax(fmax(err1,err2),fmax(fmax(err3,err4),err5))/127.;
			err=fmax(fmax(err1,err2),fmax(err3,err4))/127.;
			if(err>tol){
				h=h*fmin(1.7, fmax(0.7, 0.98*pow(tol/err, 1/8.)));
			}
			else{
				t = t + h;
				if(t<=T){
					total_err = err + total_err*exp(h*((sqrt(5)+1)/4.));
					h=h*fmin(2, fmax(0.7, 0.98*pow(tol/err, 1/8.)));
					x0=x;
					y0=y;
					p_x0 = p_x;
					p_y0 = p_y;
					B_0 = B;
				}
				else{
					t = t - h;
					h = T - t;
				}
				if(target==3)
					data<<t<< " "<< x0 << " "<< y0 << " "<< p_x0 << " "<< p_y0 << " "<< B_0<<endl;
			}
		}
		else{
			data<< t << " "<< x0 << " "<< y0 << " "<< p_x0 << " "<< p_y0 << " "<< B_0<<endl;
			t = t + h;
			x0=x;
			y0=y;
			p_x0 = p_x;
			p_y0 = p_y;
			B_0 = B;
		}
		data<< t<< " "<<  x0 << " "<< y0 << " "<< p_x0 << " "<< p_y0 << " "<< B_0<<endl;
		cout<<"Time: "<<t<<" x:"<< x0<<" y:"<<y0<< "p_x:"<<p_x<< "p_y:"<<p_y<<endl;
	}
	if(target == 1)
		return x0;
	else if (target == 2)
		return y0;
	else if (target == 10)
		return p_x0;
	else if (target == 0)
		return p_y0;
	else if (target==8)
		return B_0;
	else if (target==5)
		return total_err;
}

void task(double a){
	double delta, eps, x0, p_y0, x_11,x_12,x_21,x_22, x0_new, p_y0_new, gamma;
	delta = 1/pow(10, 8);
	eps = 1/pow(10, 8);
	x0=-1;
	p_y0=-1;
	//for(int i=0;i<6;i++)
	while(pow(pow(RK(x0,p_y0,a,0), 2) + pow(RK(x0,p_y0,a,1), 2), 1/2.) > eps){

		x_11 = ((RK(x0+delta,p_y0,a,1)) - (RK(x0,p_y0,a,1)))/delta;
		x_12 = ((RK(x0,p_y0+delta,a,1)) - (RK(x0,p_y0,a,1)))/delta;
		x_21 = ((RK(x0+delta,p_y0,a,0))  - (RK(x0,p_y0,a,0)))/delta;
		x_22 = ((RK(x0,p_y0+delta,a,0)) - (RK(x0,p_y0,a,0)))/delta;

		x0_new = (x0 - (1./(x_11*x_22 - x_12*x_21))*((RK(x0,p_y0,a,1))*x_22 - x_12*(RK(x0,p_y0,a,0))));
		p_y0_new = (p_y0 - (1./(x_11*x_22 - x_12*x_21))*(-(RK(x0,p_y0,a,1))*x_21 + x_11*(RK(x0,p_y0,a,0))));

		x0 = x0_new;
		p_y0 = p_y0_new;

		cout<<"New: "<< RK(8./3.,-8.,0,1) << " "<< RK(8./3.,-8.,0,2) << " "<< RK(8./3.,-8.,0,10) << " "<< RK(8./3.,-8.,0,0)<<endl;
		cout<<"New: <<"<< x0 << " "<< p_y0 << " "<< RK(x0, p_y0, a, 8) << " "<< RK(x0, p_y0, a, 5)<<endl;
		cout<<"Err: "<< pow(pow(RK(x0,p_y0,a,0), 2) + pow(RK(x0,p_y0,a,1), 2), 1/2.)<<endl;;
	}
	//RK(x0,p_y0,a,3);
}

int main(){
	//RK_harm();
	//RK(0,0,1,1);
	task(0);
}
